import{d as e,i as a,u as t,r as l,e as n}from"./index-e0fdaf07.js";import"./vue-echarts-85a407f1.js";import{a as r,b as s}from"./element-plus-04192b69.js";import"./store-96e17a43.js";import{u as o}from"./index-69fc4246.js";import{d as i,p,e as d,R as u,o as c,c as m,b,y as f,Y as v,a as h,J as y,M as k,K as g,N as _,I as j,al as x,ak as w,q as C,V as I,F as N}from"./@vue.runtime-core-4f5b9f62.js";import{e as W,u as V,h as q}from"./@vue.reactivity-bec702f3.js";import{_ as z}from"./_plugin-vue_export-helper-c4cb8a60.js";import{v as M,w as T}from"./@vue.runtime-dom-c19fd55a.js";import{Q as A,R as B,E as F}from"./@element-plus.icons-vue-32670eb7.js";import{j as S}from"./lodash-es-a085e596.js";import{o as U,L as $}from"./@vue.shared-5670d8a7.js";import"./axios-966d6f38.js";import"./nprogress-6d1393d1.js";import"./vue-router-18ffceba.js";import"./pinia-dbeeb1e2.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-d0bf94bd.js";import"./@vueuse.shared-3f1de09b.js";import"./vue-1d48ca3b.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./dayjs-dd470533.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-33de40b3.js";import"./tslib-ed971494.js";import"./zrender-d158d5d4.js";const R={class:"dept-select"},E=i({name:"dept-select"}),L=z(i({...E,props:{modelValue:[Array,Number,String],multiple:Boolean,checkStrictly:{type:Boolean,default:!0}},emits:["update:modelValue","change"],setup(a,{emit:t}){const l=a,{service:n}=o(),s=W(),i=W();function f(e){l.multiple||t("update:modelValue",e)}function v(e,{checkedKeys:a}){l.multiple&&t("update:modelValue",a)}return p((()=>l.modelValue),(e=>{s.value=e}),{immediate:!0}),d((()=>{n.base.sys.department.list().then((a=>{i.value=e(a)})).catch((e=>{i.value=[],r.error(e.message)}))})),(e,t)=>{const l=u("el-tree-select");return c(),m("div",R,[b(l,{modelValue:s.value,"onUpdate:modelValue":t[0]||(t[0]=e=>s.value=e),"node-key":"id",data:i.value,props:{label:"name",value:"id",children:"children"},multiple:a.multiple,"check-strictly":a.checkStrictly,"show-checkbox":a.multiple,"default-expand-all":"",onChange:f,onCheck:v},null,8,["modelValue","data","multiple","check-strictly","show-checkbox"])])}}}),[["__scopeId","data-v-6be59c9b"]]),K={class:"dept-move"},O=i({name:"dept-move"}),G=i({...O,setup(e,{expose:t}){const{service:l}=o(),n=a.exports.useForm(),i=a.exports.useCrud();return t({open:async function(e){var a;null==(a=n.value)||a.open({title:"部门转移",width:"600px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{vm:L}}],on:{submit(a,{done:t,close:n}){if(!a.departmentId)return r.warning("请选择部门"),t();s.confirm("是否转移部门？","提示",{type:"warning"}).then((()=>{l.base.sys.user.move({...a,userIds:e}).then((()=>{var e;r.success("转移成功"),null==(e=i.value)||e.refresh(),n()})).catch((e=>{r.error(e.message),t()}))})).catch((()=>null))}}})}}),(e,a)=>{const t=u("cl-form");return c(),m("div",K,[b(t,{ref_key:"Form",ref:n},null,512)])}}}),J={class:"dept-tree"},Q={class:"dept-tree__header"},Y=(e=>(x("data-v-8c9ee83a"),e=e(),w(),e))((()=>h("div",null,"组织架构",-1))),D={class:"dept-tree__op"},H={class:"no"},P=["onContextmenu"],X={class:"dept-tree__node"},Z=["onClick"],ee=["onClick"],ae=i({name:"dept-tree"}),te=z(i({...ae,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["list-change","row-click","user-add"],setup(i,{emit:p}){const x=i,{service:w}=o(),{app:C}=t(),I=W([]),N=W(),q=W(!1),z=W(!1),R=a.exports.useForm(),E=f("viewGroup");function L({data:e}){return e.parentId}function K(e,a){return a.data.parentId}async function O(){q.value=!0,z.value=!1,await w.base.sys.department.list().then((a=>{I.value=e(a),N.value||(N.value=I.value[0]),G(N.value)})),q.value=!1}function G(e){if(e){const a=e.children?l(e.children).map((e=>e.id)):[];a.unshift(e.id),N.value=e,E.checkExpand(!1),p("row-click",{item:e,ids:a})}}function ae(e){var a;const t=e.id?"update":"add";null==(a=R.value)||a.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:e,on:{submit(a,{done:l,close:n}){w.base.sys.department[t]({id:e.id,parentId:e.parentId,name:a.name,orderNum:a.orderNum}).then((()=>{r.success(`新增部门 “${a.name}” 成功`),n(),O()})).catch((e=>{r.error(e.message),l()}))}}})}function te(e){e?s.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then((async()=>{const e=[];!function a(t,l){t.forEach((t=>{t.parentId=l,e.push(t),t.children&&S(t.children)&&a(t.children,t.id)}))}(I.value,null),await w.base.sys.department.order(e.map(((e,a)=>({id:e.id,parentId:e.parentId,orderNum:a})))).then((()=>{r.success("更新排序成功")})).catch((e=>{r.error(e.message)})),O(),z.value=!1})).catch((()=>null)):O()}function le(e,t,l){t||(t=I.value[0]||{});const o=w.base.sys.department.permission;a.exports.ContextMenu.open(e,{list:[{label:"新增",hidden:l&&l.level>=x.level||!n(o.add),callback(e){ae({name:"",parentName:t.name,parentId:t.id}),e()}},{label:"编辑",hidden:!n(o.update),callback(e){ae(t),e()}},{label:"删除",hidden:!t.parentId||!n(o.delete),callback(e){!function(e){async function a(a){await w.base.sys.department.delete({ids:[e.id],deleteUser:a}).then((()=>{e.id==N.value.id&&(N.value=null),a?r.success("删除成功"):s.confirm(`“${e.name}” 部门的用户已成功转移到 “${e.parentName}” 部门。`,"删除成功")})),O()}s.confirm(`该操作会删除 “${e.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then((()=>{a(!0)})).catch((e=>{"cancel"==e&&a(!1)}))}(t),e()}},{label:"新增成员",hidden:!n(o.add),callback(e){p("user-add",t),e()}}]})}return d((function(){O()})),(e,a)=>{const t=u("el-icon"),l=u("el-tooltip"),n=u("el-button"),r=u("el-tree"),s=u("el-scrollbar"),o=u("cl-form"),p=v("loading");return c(),m("div",J,[h("div",Q,[Y,h("ul",D,[h("li",{onClick:a[0]||(a[0]=e=>O())},[b(l,{content:"刷新"},{default:y((()=>[b(t,null,{default:y((()=>[b(V(A))])),_:1})])),_:1})]),i.drag&&!V(C).browser.isMini?(c(),m("li",{key:0,onClick:a[1]||(a[1]=e=>z.value=!0)},[b(l,{content:"拖动排序"},{default:y((()=>[b(t,null,{default:y((()=>[b(V(B))])),_:1})])),_:1})])):k("",!0),g(h("li",H,[b(n,{onClick:a[2]||(a[2]=e=>te(!0)),size:"small"},{default:y((()=>[_("保存")])),_:1}),b(n,{onClick:a[3]||(a[3]=e=>te(!1)),size:"small"},{default:y((()=>[_("取消")])),_:1})],512),[[M,z.value]])])]),h("div",{class:"dept-tree__container",onContextmenu:T(le,["stop","prevent"])},[b(s,null,{default:y((()=>[g((c(),j(r,{"node-key":"id","default-expand-all":"",data:I.value,props:{label:"name"},draggable:z.value,"allow-drag":L,"allow-drop":K,"expand-on-click-node":!1,onNodeContextmenu:le},{default:y((({node:e,data:a})=>{var l;return[h("div",X,[h("span",{class:U(["dept-tree__node-label",{"is-active":a.id==(null==(l=N.value)?void 0:l.id)}]),onClick:e=>G(a)},$(e.label),11,Z),V(C).browser.isMini?(c(),m("span",{key:0,class:"dept-tree__node-icon",onClick:t=>le(t,a,e)},[b(t,null,{default:y((()=>[b(V(F))])),_:1})],8,ee)):k("",!0)])]})),_:1},8,["data","draggable"])),[[p,q.value]])])),_:1})],40,P),b(o,{ref_key:"Form",ref:R},null,512)])}}}),[["__scopeId","data-v-8c9ee83a"]]),le=i({name:"sys-user"}),ne=i({...le,setup(e){const{service:t,refs:l,setRefs:n}=o(),r=q({dept:{},ids:[]}),s=C((()=>{var e;return`成员列表（${(null==(e=r.dept)?void 0:e.name)||""}）`})),i=a.exports.useCrud({service:t.base.sys.user}),p=a.exports.useTable({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"name",label:"姓名",minWidth:150},{prop:"username",label:"用户名",minWidth:150},{prop:"nickName",label:"昵称",minWidth:150},{prop:"departmentName",label:"部门名称",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:120},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手机号码",minWidth:150},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"custom",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),d=a.exports.useUpsert({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用户名",required:!0,span:12,component:{name:"el-input"}},()=>{var e;return{prop:"password",label:"密码",span:12,required:"add"==(null==(e=d.value)?void 0:e.mode),component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密码长度在 6 到 16 个字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手机号码",span:12,component:{name:"el-input"}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(e,{next:a}){var t;a({...e,departmentId:null==(t=r.dept)?void 0:t.id})},async onOpen(){var e;const a=await t.base.sys.role.list();null==(e=d.value)||e.setOptions("roleIdList",a.map((e=>({label:e.name||"",value:e.id}))))}});function f(e){r.ids=e.map((e=>e.id))}function h({item:e,ids:a}){var t,l;r.dept=e,t={page:1,departmentIds:a},null==(l=i.value)||l.refresh(t)}function x(e){var a;null==(a=i.value)||a.rowAppend({departmentId:e.id})}async function w(e){let a=[];a=e?[e.id]:r.ids,l.value.deptMove.open(a)}return(e,a)=>{const l=u("cl-refresh-btn"),o=u("cl-add-btn"),C=u("cl-multi-delete-btn"),W=u("el-button"),q=u("cl-flex1"),z=u("cl-search-key"),M=u("el-row"),T=u("el-tag"),A=u("cl-table"),B=u("cl-pagination"),F=u("cl-upsert"),S=u("cl-crud"),U=u("cl-view-group"),R=v("permission");return c(),j(U,{title:V(s)},{left:y((()=>[b(te,{onRowClick:h,onUserAdd:x})])),right:y((()=>[b(S,{ref_key:"Crud",ref:i},{default:y((()=>[b(M,null,{default:y((()=>[b(l),b(o),b(C),g((c(),j(W,{type:"success",disabled:0==r.ids.length,onClick:a[0]||(a[0]=e=>w())},{default:y((()=>[_("转移")])),_:1},8,["disabled"])),[[R,V(t).base.sys.user.permission.move]]),b(q),b(z)])),_:1}),b(M,null,{default:y((()=>[b(A,{ref_key:"Table",ref:p,"default-sort":{prop:"createTime",order:"descending"},onSelectionChange:f},{"column-roleName":y((({scope:e})=>[e.row.roleName?(c(!0),m(N,{key:0},I(e.row.roleName.split(","),((e,a)=>(c(),j(T,{key:a,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:y((()=>[_($(e),1)])),_:2},1024)))),128)):k("",!0)])),"slot-btn":y((({scope:e})=>[g((c(),j(W,{text:"",bg:"",onClick:a=>w(e.row)},{default:y((()=>[_("转移")])),_:2},1032,["onClick"])),[[R,V(t).base.sys.user.permission.move]])])),_:1},512)])),_:1}),b(M,null,{default:y((()=>[b(q),b(B)])),_:1}),b(F,{ref_key:"Upsert",ref:d},null,512),b(G,{ref:V(n)("deptMove")},null,512)])),_:1},512)])),_:1},8,["title"])}}});export{ne as default};
