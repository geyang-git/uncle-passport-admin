import{l as e,v as a,w as s}from"./@vue.runtime-dom-c19fd55a.js";import{d as t}from"./dayjs-dd470533.js";import{D as l}from"./vuedraggable-ae969e0b.js";import{J as o,u as i,P as r}from"./@element-plus.icons-vue-32670eb7.js";import{u as d,m as p,k as u,l as c}from"./index-e0fdaf07.js";import"./vue-echarts-85a407f1.js";import{a as n}from"./element-plus-04192b69.js";import{u as m}from"./index-69fc4246.js";import{f,a as b,b as g}from"./index-3b0d487c.js";import{j as v,v as h}from"./lodash-es-a085e596.js";import{d as j,q as y,p as _,R as k,o as w,c as x,a as z,b as S,J as V,E as $,I as U,M as B,G as C,F as q,N as A,K as D}from"./@vue.runtime-core-4f5b9f62.js";import{e as P,h as F,u as I}from"./@vue.reactivity-bec702f3.js";import{o as L,L as M}from"./@vue.shared-5670d8a7.js";import{_ as O}from"./_plugin-vue_export-helper-c4cb8a60.js";import"./axios-966d6f38.js";import"./sortablejs-d20ad036.js";import"./vue-1d48ca3b.js";import"./store-96e17a43.js";import"./nprogress-6d1393d1.js";import"./vue-router-18ffceba.js";import"./pinia-dbeeb1e2.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-d0bf94bd.js";import"./@vueuse.shared-3f1de09b.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-33de40b3.js";import"./tslib-ed971494.js";import"./zrender-d158d5d4.js";const N={class:"cl-upload__wrap"},Y={class:"cl-upload__header"},E={key:0,class:"cl-upload__item"},K={class:"cl-upload__text"},R={key:1,class:"cl-upload__btn"},G={class:"cl-upload__name"},J={class:"cl-upload__size"},T={class:"cl-upload__actions"},H=["onClick"],Q=["onClick"],W={key:2,class:"cl-upload__progress"},X={key:3,class:"cl-upload__error"},Z=["src"],ee=j({name:"cl-upload"}),ae=O(j({...ee,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,size:[String,Number,Array],text:String,prefixPath:{type:String,default:"app"},showFileList:{type:Boolean,default:!0},drag:Boolean,disabled:Boolean,isEdit:null,scope:null},emits:["update:modelValue","upload","success","error","progress"],setup(j,{expose:O,emit:ee}){const ae=j;e((e=>({"045f2db2":I(ie)[0],"045f2d74":I(ie)[1]})));const{service:se}=m(),{user:te}=d(),{options:le}=p.get("upload"),oe=P(),ie=y((()=>{const e=ae.size||le.size;return(v(e)?e:[e,e]).map((e=>h(e)?e+"px":e))})),re=ae.limit||le.limit.upload,de=ae.limitSize||le.limit.size,pe=ae.text||le.text,ue=y((()=>({Authorization:te.token}))),ce=F({visible:!1,url:""}),ne=P([]),me=F({options:{group:"Upload",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:".is-drag",disabled:!ae.drag}}),fe=y((()=>ae.accept||("file"==ae.type?"*":"image/*"))),be=y((()=>ae.multiple?re-ne.value.length>0:0==ne.value.length));function ge(e){return"image"==ae.type?"image":f(e).value}function ve(e,a){if(e.size/1024/1024>=de)return n.error(`上传文件大小不能超过 ${de}MB!`),!1;const s={type:ge(e.name),preload:"",progress:0,url:"",uid:e.uid,size:e.size};return s.preload="image"==s.type?window.webkitURL.createObjectURL(e):e.name,a?Object.assign(a,s):be.value?ne.value.push(s):ne.value=[s],ee("upload",s),!0}function he(e){ne.value.splice(e,1),_e()}function je(){ne.value=[]}async function ye(e,a){a||(a=ne.value.find((a=>a.uid==e.file.uid)));try{let s=u()+"_"+e.file.name;const{mode:l,type:o}=await se.base.comm.uploadMode();return new Promise(((i,r)=>{async function d({host:o,preview:d,data:p}){const u=new FormData;for(const e in p)u.append(e,p[e]);"cloud"==l&&(s=[ae.prefixPath,t().format("YYYY-MM-DD"),s].filter(Boolean).join("/")),u.append("key",s),u.append("file",e.file),await se.request({url:o,method:"POST",headers:{"Content-Type":"multipart/form-data"},timeout:6e5,data:u,onUploadProgress(e){a.progress=parseInt(String(e.loaded/e.total*100)),ee("progress",a)},proxy:"local"==l}).then((e=>{a.url="local"===l?e:`${d||o}/${s}`,ee("success",a),i(a.url),_e()})).catch((e=>{n.error(e.message),a.error=e.message,ee("error",a),r(e)}))}"local"==l?d({host:"/admin/base/comm/upload"}):se.base.comm.upload().then((e=>{switch(o){case"cos":d({host:e.url,data:e.credentials});break;case"oss":d({host:e.host,data:{OSSAccessKeyId:e.OSSAccessKeyId,policy:e.policy,signature:e.signature}});break;case"qiniu":d({host:e.uploadUrl,preview:e.publicDomain,data:{token:e.token}})}})).catch(r)}))}catch(s){n.error("上传配置错误")}}function _e(){ne.value.find((e=>!e.url))||ee("update:modelValue",ne.value.map((e=>e.url)).join(","))}return _((()=>ae.modelValue),(e=>{const a=(v(e)?e:(e||"").split(",")).filter(Boolean);ne.value=a.map((e=>{const a=ne.value.find((a=>e==a.url));return a||{type:ge(e),progress:0,uid:u(),url:e,preload:e}})).filter(((e,a)=>!!ae.multiple||0==a))}),{immediate:!0}),O({isAdd:be,list:ne,check:function(){return ne.value.find((e=>100!=e.progress))},clear:je,remove:he,upload(e){je(),oe.value.clearFiles(),oe.value.handleStart(e),oe.value.submit()}}),(e,t)=>{const d=k("el-icon"),p=k("el-button"),u=k("el-upload"),n=k("el-image"),m=k("el-progress"),f=k("cl-dialog");return w(),x(q,null,[z("div",N,[z("div",{class:L(["cl-upload",[`cl-upload--${j.type}`,{"is-slot":e.$slots.default,"is-custom":e.$slots.item,"is-disabled":j.disabled}]])},[z("div",Y,[S(u,{ref_key:"Upload",ref:oe,action:"",accept:I(fe),"show-file-list":!1,"before-upload":ve,"http-request":ye,headers:I(ue),multiple:j.multiple,disabled:j.disabled},{default:V((()=>[$(e.$slots,"default",{},(()=>["image"==j.type&&I(be)?(w(),x("div",E,[S(d,{size:24},{default:V((()=>[S(I(o))])),_:1}),z("span",K,M(I(pe)),1)])):B("",!0),"file"==j.type?(w(),x("div",R,[S(p,{type:"success"},{default:V((()=>[A(M(I(pe)),1)])),_:1})])):B("",!0)]),!0)])),_:3},8,["accept","headers","multiple","disabled"])]),S(I(l),C({modelValue:ne.value,"onUpdate:modelValue":t[0]||(t[0]=e=>ne.value=e)},me.options,{"item-key":"uid",tag:"div",class:"cl-upload__list",onEnd:_e}),{item:V((({element:t,index:l})=>[j.showFileList?(w(),U(u,{key:0,action:"",class:"is-drag",accept:I(fe),"show-file-list":!1,"http-request":e=>ye(e,t),"before-upload":e=>{ve(e,t)},headers:I(ue),disabled:j.disabled},{default:V((()=>[$(e.$slots,"item",{item:t,index:l},(()=>[z("div",{class:L(["cl-upload__item",[`is-${t.type}`]])},["image"==t.type?(w(),U(n,{key:0,src:t.preload,fit:"cover"},null,8,["src"])):(w(),x(q,{key:1},[z("span",G,M(I(b)(t.preload))+"."+M(I(c)(t.preload)),1),z("span",J,M(I(g)(t.size)),1)],64)),z("div",T,[D(z("span",{onClick:s((e=>function(e){"image"==e.type?(ce.visible=!0,ce.url=e.url):window.open(e.url)}(t)),["stop"])},[S(d,null,{default:V((()=>[S(I(i))])),_:1})],8,H),[[a,t.url]]),j.disabled?B("",!0):(w(),x("span",{key:0,onClick:s((e=>he(l)),["stop"])},[S(d,null,{default:V((()=>[S(I(r))])),_:1})],8,Q))]),t.progress>0&&t.progress<100?(w(),x("div",W,[S(m,{percentage:t.progress,"show-text":!1},null,8,["percentage"])])):B("",!0),t.error?(w(),x("div",X,M(t.error),1)):B("",!0)],2)]),!0)])),_:2},1032,["accept","http-request","before-upload","headers","disabled"])):B("",!0)])),_:3},16,["modelValue"])],2)]),S(f,{modelValue:ce.visible,"onUpdate:modelValue":t[1]||(t[1]=e=>ce.visible=e),title:"图片预览",width:"500px"},{default:V((()=>[z("img",{style:{width:"100%"},src:ce.url},null,8,Z)])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-d45b389a"]]);export{ae as default};
